%----------
%	CONFIGURACIÓN DEL DOCUMENTO
%----------

% Definimos las características del documento y añadimos una serie de paquetes (\usepackage{package}) que agregan funcionalidades a LaTeX.

\documentclass[12pt]{report} %fuente a 12pt

% MÁRGENES: 2,5 cm sup. e inf.; 3 cm izdo. y dcho.
\usepackage[
a4paper,
vmargin=2.5cm,
hmargin=3cm
]{geometry}

% INTERLINEADO: Estrecho (6 ptos./interlineado 1,15) o Moderado (6 ptos./interlineado 1,5)
\renewcommand{\baselinestretch}{1.15}
\parskip=6pt

% DEFINICIÓN DE COLORES para portada y listados de código
\usepackage[table]{xcolor}
\definecolor{azulUC3M}{RGB}{0,0,102}
\definecolor{gray97}{gray}{.97}
\definecolor{gray75}{gray}{.75}
\definecolor{gray45}{gray}{.45}

% Soporte para GENERAR PDF/A --es importante de cara a su inclusión en e-Archivo porque es el formato óptimo de preservación y a la generación de metadatos, tal y como se describe en http://uc3m.libguides.com/ld.php?content_id=31389625. En la carpeta incluímos el archivo plantilla_tfg_2017.xmpdata en el que puedes incluir los metadatos que se incorporarán al archivo PDF cuando lo compiles. Ese archivo debe llamarse igual que tu archivo .tex. Puedes ver un ejemplo en esta misma carpeta.
\usepackage[a-1b]{pdfx}

% ENLACES
\usepackage{hyperref}
\hypersetup{colorlinks=true,
	linkcolor=black, % enlaces a partes del documento (p.e. índice) en color negro
	urlcolor=blue} % enlaces a recursos fuera del documento en azul

% EXPRESIONES MATEMATICAS
\usepackage{amsmath,amssymb,amsfonts,amsthm}

\usepackage{txfonts} 
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}

\usepackage[spanish, es-tabla]{babel} 
\usepackage[babel, spanish=spanish]{csquotes}
\usepackage{etoolbox}
\AtBeginEnvironment{quote}{\small}

% diseño de PIE DE PÁGINA
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}
\rfoot{\thepage}
\fancypagestyle{plain}{\pagestyle{fancy}}

% DISEÑO DE LOS TÍTULOS de las partes del trabajo (capítulos y epígrafes o subcapítulos)
\usepackage{titlesec}
\usepackage{titletoc}
\titleformat{\chapter}[block]
{\large\bfseries\filcenter}
{\thechapter.}
{5pt}
{\MakeUppercase}
{}
\titlespacing{\chapter}{0pt}{0pt}{*3}
\titlecontents{chapter}
[0pt]                                               
{}
{\contentsmargin{0pt}\thecontentslabel.\enspace\uppercase}
{\contentsmargin{0pt}\uppercase}                        
{\titlerule*[.7pc]{.}\contentspage}                 

\titleformat{\section}
{\bfseries}
{\thesection.}
{5pt}
{}
\titlecontents{section}
[5pt]                                               
{}
{\contentsmargin{0pt}\thecontentslabel.\enspace}
{\contentsmargin{0pt}}
{\titlerule*[.7pc]{.}\contentspage}

\titleformat{\subsection}
{\normalsize\bfseries}
{\thesubsection.}
{5pt}
{}
\titlecontents{subsection}
[10pt]                                               
{}
{\contentsmargin{0pt}                          
	\thecontentslabel.\enspace}
{\contentsmargin{0pt}}                        
{\titlerule*[.7pc]{.}\contentspage}  


% DISEÑO DE TABLAS. Puedes elegir entre el estilo para ingeniería o para ciencias sociales y humanidades. Por defecto, está activado el estilo de ingeniería. Si deseas utilizar el otro, comenta las líneas del diseño de ingeniería y descomenta las del diseño de ciencias sociales y humanidades
\usepackage{multirow} % permite combinar celdas 
\usepackage{caption} % para personalizar el título de tablas y figuras
\usepackage{floatrow} % utilizamos este paquete y sus macros \ttabbox y \ffigbox para alinear los nombres de tablas y figuras de acuerdo con el estilo definido. Para su uso ver archivo de ejemplo 
\usepackage{array} % con este paquete podemos definir en la siguiente línea un nuevo tipo de columna para tablas: ancho personalizado y contenido centrado
\newcolumntype{P}[1]{>{\centering\arraybackslash}p{#1}}
\DeclareCaptionFormat{upper}{#1#2\uppercase{#3}\par}

% Diseño de tabla para ingeniería
\captionsetup[table]{
	format=upper,
	name=TABLA,
	justification=centering,
	labelsep=period,
	width=.75\linewidth,
	labelfont=small,
	font=small,
}

%Diseño de tabla para ciencias sociales y humanidades
%\captionsetup[table]{
%	justification=raggedright,
%	labelsep=period,
%	labelfont=small,
%	singlelinecheck=false,
%	font={small,bf}
%}


% DISEÑO DE FIGURAS. Puedes elegir entre el estilo para ingeniería o para ciencias sociales y humanidades. Por defecto, está activado el estilo de ingeniería. Si deseas utilizar el otro, comenta las líneas del diseño de ingeniería y descomenta las del diseño de ciencias sociales y humanidades
\usepackage{graphicx}
\graphicspath{{res/}} %ruta a la carpeta de imágenes

\usepackage{afterpage}
% Diseño de figuras para ingeniería
\captionsetup[figure]{
	format=hang,
	name=Fig.,
	singlelinecheck=off,
	labelsep=period,
	labelfont=small,
	font=small		
}


% NOTAS A PIE DE PÁGINA
\usepackage{chngcntr} %para numeración contínua de las notas al pie
\counterwithout{footnote}{chapter}

% LISTADOS DE CÓDIGO
% soporte y estilo para listados de código. Más información en https://es.wikibooks.org/wiki/Manual_de_LaTeX/Listados_de_código/Listados_con_listings
\usepackage{listings}

% definimos un estilo de listings
\lstdefinestyle{estilo}{ frame=Ltb,
	framerule=0pt,
	aboveskip=0.5cm,
	framextopmargin=3pt,
	framexbottommargin=3pt,
	framexleftmargin=0.4cm,
	framesep=0pt,
	rulesep=.4pt,
	backgroundcolor=\color{gray97},
	rulesepcolor=\color{black},
	%
	basicstyle=\ttfamily\footnotesize,
	keywordstyle=\bfseries,
	stringstyle=\ttfamily,
	showstringspaces = false,
	commentstyle=\color{gray45},     
	%
	numbers=left,
	numbersep=15pt,
	numberstyle=\tiny,
	numberfirstline = false,
	breaklines=true,
	xleftmargin=\parindent
}

\captionsetup[lstlisting]{font=small, labelsep=period}
% fijamos el estilo a utilizar 
\lstset{style=estilo}
\renewcommand{\lstlistingname}{\uppercase{Código}}


%BIBLIOGRAFÍA - PUEDES ELEGIR ENTRE ESTILO IEEE O APA. POR DEFECTO ESTÁ CONFIGURADO IEEE. SI DESEAS USAR APA, COMENTA LAS LÍNEA DE IEEE Y DESCOMENTA LAS DE APA. Si haces cambios en la configuración de la bibliografía y no obtienes los resultados esperados, es recomendable limpiar los archivos auxiliares y volver a compilar en este orden: COMPILAR-BIBLIOGRAFIA-COMPILAR

% Tienes más información sobre cómo generar bibliografía y CONFIGURAR TU EDITOR DE TEXTO para compilar con biber en http://tex.stackexchange.com/questions/154751/xx-with-biber-configuring-my-editor-to-avoid-undefined-citations , https://www.overleaf.com/learn/latex/Bibliography_management_in_LaTeX y en http://www.ctan.org/tex-archive/macros/latex/exptl/biblatex-contrib
% También te recomendamos consultar la guía temática de la Biblioteca sobre citas bibliográficas: http://uc3m.libguides.com/guias_tematicas/citas_bibliograficas/inicio

% CONFIGURACIÓN PARA LA BIBLIOGRAFÍA IEEE
\usepackage[backend=biber, style=ieee, isbn=false,sortcites, maxbibnames=5, minbibnames=1]{biblatex} % Configuración para el estilo de citas de IEEE, recomendado para el área de ingeniería. "maxbibnames" indica que a partir de 5 autores trunque la lista en el primero (minbibnames) y añada "et al." tal y como se utiliza en el estilo IEEE.

% Añadimos las siguientes indicaciones para mejorar la adaptación de los estilos en español
\DefineBibliographyStrings{spanish}{%
	andothers = {et\addabbrvspace al\adddotspace}
}
\DefineBibliographyStrings{spanish}{
	url = {\adddotspace[En línea]\adddotspace Disponible en:}
}
\DefineBibliographyStrings{spanish}{
	urlseen = {Acceso:}
}
\DefineBibliographyStrings{spanish}{
	pages = {pp\adddotspace},
	page = {p.\adddotspace}
}


\addbibresource{bib/bibliography.bib} % llama al archivo bibliografia.bib en el que debería estar la bibliografía utilizada

% my settings
\linespread{1.5}
\usepackage{float}
\usepackage[bottom]{footmisc}
\usepackage{enumitem}
\newcommand{\sigmadelta}{$\Sigma\Delta\; $}
\usepackage{microtype}
\usepackage{multicol}
\usepackage{listings}


%-------------
%	DOCUMENTO
%-------------

\begin{document}
\pagenumbering{roman} % Se utilizan cifras romanas en la numeración de las páginas previas al cuerpo del trabajo

%----------
%	PORTADA
%----------	
\begin{titlepage}

	\begin{sffamily}
	\color{azulUC3M}
	\begin{center}
		\begin{figure}[H] %incluimos el logotipo de la Universidad
			\makebox[\textwidth][c]{\includegraphics[width=16cm]{res/Portada_Logo.png}}
		\end{figure}
		\vspace{2.5cm}
		\begin{Large}
			Grado en Ingeniería en Tecnologías Industriales		
			2019-2020
			\vspace{2cm}		
			\textsl{Trabajo de Fin de Grado}
			\bigskip
			
		\end{Large}
		 	{\Huge LINEALIZACIÓN DE OSCILADOR EN ANILLO CONTROLADO POR TENSIÓN MEDIANTE CAPACIDADES CONMUTADAS}\\
		 	\vspace*{0.5cm}
	 		\rule{10.5cm}{0.1mm}\\
			\vspace*{0.9cm}
			{\LARGE Roberto Uceda Gómez}\\ 
			\vspace*{1cm}
		\begin{Large}
			Tutor:
			Eric Gutiérrez Fernández \\
			Leganés, %TODO: fecha \\
		\end{Large}
	\end{center}
	\vfill
	\color{black}
	% si nuestro trabajo se va a publicar con una licencia Creative Commons, incluir estas líneas. Es la opción recomendada.
	\includegraphics[width=4.2cm]{res/creativecommons.png}\\ %incluimos el logotipo de creativecommons
	Esta obra se encuentra sujeta a la licencia Creative Commons\\ \textbf{Reconocimiento - No Comercial - Sin Obra Derivada}
	\end{sffamily}
\end{titlepage}

\newpage %página en blanco o de cortesía
\thispagestyle{empty}
\mbox{}

%----------
%	RESUMEN Y PALABRAS CLAVE
%----------	
\renewcommand\abstractname{\large\bfseries\filcenter\uppercase{Resumen}}
\begin{abstract}
\thispagestyle{plain}
\setcounter{page}{3}
	
	% ESCRIBIR EL RESUMEN AQUÍ
	En este trabajo se desarrolla un estudio cuyo objetivo es encontrar una manera de linealizar el comportamiento de una nueva arquitectura de ADC basado en VCO, sin necesidad del uso de amplificador operacional, como se ha hecho hasta ahora.
	
	\textbf{Palabras clave: ADC-VCO, Oscilador en anillo, Conversión Analógico-Digital, CMOS}
	% Escribir las palabras clave aquí
	
	%TODO
	\vfill
\end{abstract}
	\newpage % página en blanco o de cortesía
	\thispagestyle{empty}
	\mbox{}


%----------
%	DEDICATORIA
%----------	
\chapter*{Dedicatoria}

\setcounter{page}{5}
	
	%TODO
		
	\vfill
	
	\newpage % página en blanco o de cortesía
	\thispagestyle{empty}
	\mbox{}
	

%----------
%	ÍNDICES
%----------	

%--
% Índice general
%-
\tableofcontents
\thispagestyle{fancy}


%--
% Índice de figuras. Si no se incluyen, comenta las líneas siguientes
%-
\listoffigures
\thispagestyle{fancy}


%--
% Índice de tablas. Si no se incluyen, comenta las líneas siguientes
%-
\listoftables
\thispagestyle{fancy}


%--
% Lista de abreviaturas. Si no se incluyen, comenta las líneas siguientes
%-
\newpage
\begin{table}[h!]
	\setlength{\arrayrulewidth}{0mm}
	\begin{center}
		\caption{Lista de abreviaturas}
		\label{tab:table1}
		\begin{tabular}{>{\bf}p{4cm}|p{10cm}}
			ADC & Analog to Digital Converter, Convertidor Analógico-Digital \\
			CMOS & Complimentary Metal-Oxide Semiconductor \\
			MOSFET & Metal Oxide Semiconductor Field Effect Transistor, también llamados transistores MOS \\
		\end{tabular}
	\end{center}
\end{table}

\newpage % página en blanco o de cortesía
\thispagestyle{empty}
\mbox{}

%----------
%	TRABAJO
%----------	
\clearpage
\pagenumbering{arabic} % numeración con múmeros arábigos para el resto de la publicación	

\chapter{Introducción}

	Los ADC\footnote{Analog to Digital Converter. En español, Convertidor Analógico a Digital} son onmipresentes en nuestro día a día. Sin ellos, no sería posible realizar una llamada con un teléfono móvil, o disfrutar de un sistema de climatización en nuestro hogar, o utilizar el control de crucero en nuestro coche. El objetivo de estos importantes bloques de la electrónica es convertir señales físicas, como ondas electromagnéticas, temperatura ambiente, o la posición de un eje, en señales digitales interpretables por un sistema basado en la electrónica digital. Una vez tenemos estas señales, normalmente compuestas por un flujo de bits, pueden ser procesadas por un microcontrolador para después tomar las decisiones necesarias para conseguir el objetivo deseado, como activar el compresor del aire acondicionado si la temperatura sube de cierto límite preestablecido.
	
	Cada día que pasa aumenta la demanda de aparatos más rápidos, compactos, y eficientes. Por regla general, la miniaturización de la electrónica tiene un impacto positivo en estos criterios. Los transistores son los componentes fundamentales de los circuitos integrados. Estos transistores aumentan su eficiencia energética según disminuye su tamaño, además de permitir mayores frecuencias de operación. Por esto, existe un gran incentivo en la búsqueda de arquitecturas y técnicas de fabricación que permitan transistores más pequeños.
	
	La ley de Moore ayuda a poner un poco de contexto histórico a esta carrera por la disminución de los transistores. Gordon Moore anunció en 1965 una tendencia en la, por aquel entonces emergente, industria de la electrónica: cada dos años se duplicaba la cantidad de componentes presente en un circuito integrado en la misma superficie \cite{moorelaw}. A más componentes, mayor poder de procesamiento, pero también mayor coste de fabricación por la complejidad y delicadeza requerida en los procesos.
	
	\section{Motivación del trabajo}
	
	Debido a las altas velocidades de reloj y los requisitos de consumo y fabricación (espacio ocupado, número de componentes, reducción del tamaño de los transistores), los ADC usados actualmente presentan problemas. Los ADC basados en la arquitectura sigma delta, los más comunes en aplicaciones de bajo ancho de banda y alta resolución (audio, sensores biométricos y de alta precisión), requieren de un integrador. Estos integradores normalmente trabajan en el ámbito analógico, y la gran mayoría usan un amplificador operacional, con gran número de componentes y alto consumo.
	
	Con las tecnologías de fabricación actuales, se consiguen transistores de tamaños diminutos, con buen tiempo de respuesta y bajo consumo en aplicaciones digitales, pero efectos adversos en aplicaciones analógicas.
	%TODO: ERIC: pon algún ejemplo numérico
	Algunos de estos efectos son la degradación de la señal por efectos cuánticos y defectos en la fabricación (el tamaño nominal de un transistor CMOS de tecnología puntera es entre un cuarto y una décima parte la longitud de onda de la luz ultravioleta usada en litografía), altas corrientes parásitas por el bajo tamaño de la puerta del transistor, y limitaciones en la simulación de sistemas por la alta densidad y complejidad en los microchips actuales. Otro efecto negativo que tiene la miniaturización en el diseño de microcircuitos es la falta de escalabilidad de la tensión de corte de los MOSFET. Mientras que la tensión de alimentación baja con el tamaño, la de corte no lo hace en la misma medida, haciendo más difícil el diseño de estructuras de alta ganancia, como los amplificadores operacionales, que requieren de suficiente diferencia entre ambas tensiones. %TODO: preguntar a Eric. es por los amplificadores en cascada?
	
	Además, a pesar de que el consumo individual de los transistores disminuye al reducirse su tamaño, lo hace de manera lineal, mientras que su incremento en número por unidad de superficie crece de manera cuadrática. Esto provoca un gran problema en cuanto a disipación térmica, por eso aumentar el número de componentes en circuitos integrados no es una solución en ciertos casos en que no pueda gestionarse correctamente el calor generado, como en sistemas embebidos y aplicaciones de muy bajo consumo, como dispositivos del IoT\footnote{Internet of Things. En español: Internet de las Cosas}.
	
	Los ADC basados en VCO actuales necesitan una compensación de linealidad mediante circuitería digital, que termina ocupando la mayor parte de la superficie del chip. Este trabajo se centra en la búsqueda de una nueva arquitectura usando un VCO tanto como integrador como cuantificador, que permita ahorrar la necesidad de circuitos de compensación y circuitos analógicos complejos (amplificadores operacionales), manteniendo o mejorando el comportamiento lineal, la resolución, y el ancho de banda de las arquitecturas ya existentes.
	
	\section{Objetivos}
	
	El grueso de este trabajo se encuentra en el plano teórico. El primer paso es realizar un estudio de las arquitecturas de ADC ya existentes, centrándose en aquellas que emplean VCOs. A partir de este estudio, se estudiará la viabilidad de varias ideas de diferentes publicaciones que aún no han sido implementadas. Para esto, se utilizarán herramientas de simulación basadas en SPICE. Una vez probada la efectividad de la arquitectura, la siguiente tarea será montar un circuito con componentes discretos sobre protoboard, medir los parámetros de funcionamiento, y así dejar demostrada la factibilidad de la arquitectura.
	%TODO: consultar Eric

	\section{Marco regulador}
	%TODO: ERIC: Apenas se podría decir algo, pero debes decirlo. Puedes hablar de las aplicaciones del sistema, por ejemplo para un micrófono y de ahí enlazar con la ley de privacidad por grabar con el micrófono la voz de la gente. Llévalo a la aplicación concreta y ahí habla de leyes de privacidad, almacenamiento de datos...
	
	
	\section{Esquema de este documento}
	%TODO por decidir
	

	
	

\chapter{Estado del arte}

	Para entender las arquitecturas de ADC modernas es imprescindible conocer primero los bloques fundamentales sobre los que se asienta la microelectrónica actualmente: los transistores MOSFET\footnote{Metal Oxide Semiconductor Field Effect Transistor}.
	
	\section{Transistores MOS}
	
	\begin{figure}[H]
		\includegraphics[width=\textwidth]{mos_transistor.png}
		\caption[Corte de transistor MOSFET]{Corte de transistor MOSFET\protect\footnotemark}
		\label{fig:mos_transistor.png}
	\end{figure}

	\footnotetext{Fuente: \url{http://ece-research.unm.edu/jimp/vlsi/slides/chap2_1.html} }
	
	Un transistor MOSFET es un tipo de transistor que se usa para amplificar y conmutar señales eléctricas dentro de un circuito. Se compone de cuatro entradas: fuente, puerta, drenador, y sustrato, que normalmente está conectado a la fuente para evitar la modulación de la tensión de corte. Cuando se aplica un voltaje en la puerta, se crea un canal en el medio semiconductor que permite el paso de corriente entre la fuente y el drenador. Podemos distinguir dos tipos de transistores MOS: los canal-n y los canal-p, dependiendo del dopaje del silicio usado en su fabricación. Los canal-n tienen un dopaje negativo en el silicio de la fuente y el drenador, que se consigue añadiendo impurezas de un elemento como fósforo, dejando electrones libres que actúan como portadores de carga. En el caso de los canal-p, se dopan con elementos como boro, que dejan huecos (ausencia de electrones en capas de valencia), y estos actúan como portadores de carga.
	
	Estos son los símbolos más usados para representar transistores MOS:
	
	\begin{figure}[H]
		\includegraphics[width=0.8\textwidth]{p-mos-symbol.png}
		\caption[Transistor MOS, canal-p]{Transistor MOS, canal-p\protect\footnotemark}
		\label{fig:p-mos-symbol.png}
	\end{figure}

	\footnotetext{Fuente: \cite{aicd}}
	
	\begin{figure}[H]
		\includegraphics[width=0.8\textwidth]{n-mos-symbol.png}
		\caption[Transistor MOS, canal-n]{Transistor MOS, canal-n\protect\footnotemark}
		\label{fig:n-mos-symbol.png}
	\end{figure}
	
	
	\footnotetext{Fuente: \cite{aicd}}
	
	\section{Tecnología CMOS}
	
	La tecnología de fabricación CMOS\footnote{Complementary MOS} utiliza una combinación de transistores MOS de canal n y canal p para implementar las operaciones lógicas. Fue desarrollada en la década de 1960 por empleados de la compañía Fairchild Semiconductor\cite{cmos-fairchild}.
	
	Por ejemplo, un inversor (puerta lógica NOT) se consigue con la siguiente disposición:
	
	\begin{figure}[H]
		\includegraphics[width=0.75\textwidth]{inverter_mos.jpg}
		\caption[Inversor CMOS]{Inversor CMOS\protect\footnotemark}
		\label{fig:inverter_mos.jpg}
	\end{figure}
	\footnotetext{Fuente: \url{https://www.oreilly.com/library/view/introduction-to-digital/9780470900550/chap5-sec008.html} }
	
	
	Los circuitos CMOS tienen un bajo consumo estático, ya que una vez formado el canal en región activa, la alta impedancia de entrada provoca un paso de corriente casi nulo, únicamente provocado por corrientes parásitas. También tienen una buena tolerancia al ruido por su propiedad regenerativa de la señal: si entra una señal degradada a una puerta CMOS, esta volverá al valor lógico que corresponda, dentro de las tolerancias que permita el circuito. Por estas propiedades es por las que la tecnología CMOS se ha convertido en dominante en el diseño de microcircuitos en la actualidad.
	
	\section{Conversión analógico-digital}
	
	La tarea de un convertidor analógico-digital, o ADC, es tomar una señal eléctrica analógica y transformarla en una digital. Una señal analógica es aquella producida por un fenómeno electromanético y representable por una función continua que define su periodo y amplitud. Una señal digital es una sucesión de diferentes valores discretos con un espaciado temporal uniforme.
	
	\begin{figure}[H]
		\includegraphics[width=0.75\textwidth]{analog-vs-digital-signal.jpg}
		\caption[Señal analógica a digital]{Señal analógica a digital\protect\footnotemark}
		\label{fig:analog-vs-digital-signal.jpg}
	\end{figure}
	\footnotetext{Fuente: \url{https://electronics.stackexchange.com/questions/352784/in-digital-systems-do-we-discretize-both-time-and-magnitude-or-only-time} }
	
	En un ADC, la señal analógica original sufre dos transformaciones: un muestreo y una cuantificación. El muestro toma valores de la señal a una frecuencia concreta, descartando los intermedios. La cuantificación transforma el espectro continuo de la señal en un conjunto de valores finito. Esto es suficiente para lograr un conjunto de palabras (conjunto de bits de longitud definida) a una frecuencia de trabajo, para ser almacenadas o procesadas por un microcontrolador.
	
	Estos son algunos de los parámetros básicos que describen el comportamiento y prestaciones de un ADC:
	
	\begin{description}[font=\bfseries, style=multiline, align=left, before={\renewcommand\makelabel[1]{\bfseries ##1:}}]
		\item[Frecuencia de muestreo] Frecuencia a la cual se toman medidas de la señal original. Determinado por el ancho de banda de la aplicación.
		\item[Ancho de banda] Rango de frecuencias de la señal original que puede ser correctamente muestreada, cuantizada, y posteriormente recreada. 
		\item[Resolución] Número de pasos máximo entre rango de valores de la señal analógica. Determina el error de cuantificación y el SNR máximo.
		\item[SNR] La Signal-to-Noise Ratio, o Relación Señal-Ruido, es la relación entre la potencia de la señal transmitida y la potencia del ruido presente en dicha señal. Normalmente se representa en dB. 
			\begin{figure}[H]
				\begin{equation}
					\label{snr}
					SNR = \frac{P_{signal}}{P_{noise}}
				\end{equation}
			\end{figure}
			\begin{figure}[H]
				\begin{equation}
					\label{snr-db}
					SNR_{dB} = 10 log_{10} (\frac{P_{signal}}{P_{noise}})
				\end{equation}
			\end{figure}
					
	\end{description}

	En cuanto a errores en la conversión, estas son las principales fuentes:
	
	\begin{description}[font=\bfseries, style=multiline, align=left, before={\renewcommand\makelabel[1]{\bfseries ##1:}}]
		\item[Cuantificación] Para una muestra dada en un momento determinado, es la diferencia entre el valor de la señal original y valor de la señal cuantificada.
		\item[Linealidad] Falta de correlación lineal entre entrada y salida del ADC. Necesita ser corregida para evitar divergencias entre entrada y salida que distorsionan la lectura.
	\end{description}

	Es importante diferenciar dos tipos de ADC según su frecuencia de muestreo:
	\begin{description}[font=\bfseries, style=multiline, align=left, before={\renewcommand\makelabel[1]{\bfseries ##1:}}]
		\item[A frecuencia de Nyquist] La frecuencia de muestreo es igual a dos veces la frecuencia máxima de la señal a capturar\cite{nyquist}\cite{shannon-nyquist}. El teorema de Nyquist habla de esta frecuencia como la mínima a la que es matemáticamente posible recrear una señal perfectamente a partir de las muestras tomadas.
		\item[Sobremuestreados] La frecuencia de muestreo es superior a la frecuencia de Nyquist; habitualmente unas diez veces mayor.
	\end{description}
	
	\section{Arquitecturas de ADC actuales}
	
	Existen multitud de arquitecturas ADC, entre ellas: flash, aproximaciones sucesivas, de integración, de rampa, de seguimiento, tensión-frecuencia. Algunos ejemplos:
	
	\begin{figure}[H]
		\includegraphics[width=0.5\textwidth]{flash-adc.png}
		\caption[ADC de conversión directa tipo flash]{ADC de conversión directa tipo flash\protect\footnotemark}
		\label{fig:flash-adc.png}
	\end{figure}
	\footnotetext{Fuente: \url{https://www.allaboutcircuits.com/textbook/digital/chpt-13/flash-adc/} }
	\begin{figure}[H]
		\includegraphics[width=0.6\textwidth]{integrator-adc-double-ramp.png}
		\caption[ADC integrador de doble rampa]{ADC integrador de doble rampa\protect\footnotemark}
		\label{fig:integrator-adc-double-ramp.png}
	\end{figure}
	\footnotetext{Fuente: \url{http://www.electronics-tutorial.net/analog-integrated-circuits/data-converters/dual-slope-type-adc/} }
	
	Los más cercanos a la materia de este estudio son los de integración, en concreto los que utilizan la modulación sigma-delta.
	
	\section{Modulación sigma-delta en ADCs}
	
	Un ADC que utiliza el principio de modulación sigma-delta, también llamado \textit{modulador sigma-delta}, o \textit{modulador \sigmadelta}, tiene como bloques principales un sumador
	%TODO: digo sumador, pero se ve claramente que suma la señal negada. no sé si está claro. lo he visto normalmente escrito como sumador, aunque reste
	, un integrador, y un cuantificador, además de un bucle de realimentación. Este es el esquema de bloques básico de un modulador \sigmadelta:
	
	\begin{figure}[H]
		\includegraphics[width=0.6\textwidth]{sigma-delta-blocks.png}
		\caption[Bloques de un modulador \sigmadelta]{Bloques de un modulador \sigmadelta\protect\footnotemark}
		\label{fig:sigma-delta-blocks.png}
	\end{figure}
	\footnotetext{Fuente: Oversampled Analog-To-Digital Converter Architectures Based On Pulse Frequency Modulation\cite{eric-thesis} }
	
	El funcionamiento de este tipo de ADC sigue los pasos siguientes. La señal original $( x(t) )$ es sumada a la salida del cuantificador $( y(t) )$ en magnitud negativa. La salida $( y(t) )$ es un flujo de un bit de profundidad, por lo que debe ser transformada a magnitud real a través de un DAC. El integrador forma un filtro de paso bajo sobre la diferencia entre señal original y cuantificada de tal manera que se consigue una realimentación de baja frecuencia, consiguiendo una reducción del ruido de cuantificación en la banda de respuesta.
	
	Este es un ejemplo gráfico del resultado de la modulación \sigmadelta:
	
	\begin{figure}[H]
		\includegraphics[width=\textwidth]{sd-modulation-example.jpg}
		\caption[Modulación \sigmadelta de una señal de 1.5kHz]{Modulación \sigmadelta de una señal de 1.5kHz\protect\footnotemark}
		\label{fig:sd-modulation-example.jpg}
	\end{figure}

	\footnotetext{Fuente: \url{http://www.cs.tut.fi/sgn/arg/rosti/1-bit/} }
	
	Se puede observar que el promedio de la señal modulada de 1 bit es proporcional a la señal original.
	
	Con respecto a un ADC de aproximaciones sucesivas o de seguimiento, la modulación \sigmadelta una gran linealidad en la curva de respuesta y una disminución del ruido de fondo, ya que el bucle tenderá a hacer que la salida \begin{math} y(t) \end{math} sea cero. El cuantificador suele ser un comparador implementado con un amplificador operacional de alta ganancia, con una referencia ajustada a la aplicación. Además suele existir un circuito sample-and-hold con una frecuencia de reloj que se ajusta a la entrada al circuito que recibirá la señal ya convertida a digital.
	
	En cuanto al integrador, las implementaciones más comunes son con un amplificador operacional o por transconductancia.
	
	\begin{figure}[H]
		\includegraphics[width=\textwidth]{integrator-opamp-trans.png}
		\caption[Integradores por opamp (a) y por transconductancia (b)]{Integradores por opamp (a) y por transconductancia (b)\protect\footnotemark}
		\label{fig:integrator-opamp-trans.png}
	\end{figure}
	
	\footnotetext{Fuente: \cite{eric-thesis} }
	
	Como se puede observar, ambas opciones trabajan en ámbito analógico.
	
	Las principales desventajas de la conversión por modulador \sigmadelta son la necesidad de una frecuencia de muestreo muy alta respecto a la original, lo cual es un problema a la hora de convertir señales de muy alta frecuencia;
	%TODO: añadir más desventajas
	

	
\chapter{Análisis}
	
	%TODO: nombre para este capítulo
	
	En este capítulo se expone el análisis de una nueva arquitectura de ADC que emplea un VCO como cuantificador e integrador.
	
	\section{Idea inicial}
	
	La idea fundamental de esta nueva arquitectura es, partiendo de un sistema de ADC por VCO en bucle abierto, estudiar la viabilidad de linealizar la respuesta mediante un bucle de realimentación, haciendo uso de la ganancia intrínseca de la dispone el propio oscilador. Esto eliminaría la necesidad de un amplificador operacional presente en las arquitecturas de VCO con realimentación existentes hoy en día, rebajando por tanto el número de componentes necesarios y el consumo total del sistema.
	
	La idea principal de esta arquitectura viene de publicaciones que ya hacen uso de un bucle de realimentación con DAC de 1 bit controlado por frecuencia. En esta publicación: \textit{VCO-ADC linearization by switched capacitorfrequency-to-current conversion}\cite{vco-adc-ruben-eric} ya se destacan los beneficios de un ADC por VCO con realimentación, como son una mayor resistencia al ruido por jitter del reloj, mayor resistencia al ruido térmico de los componentes pasivos, y una mejora importante de la relación señal-ruido con respecto a un ADC VCO en bucle abierto. El problema de la arquitectura propuesta en la publicación es que no consigue prescindir de un amplificador operacional, que sigue siendo el componente más complejo, costoso, y con gran consumo.
	
	En este estudio, exploraremos la posibilidad de usar la ganancia intrínseca del VCO para poder eliminar el amplificador operacional, para reducir el consumo y el tamaño del ADC, y abrir su uso a nuevas aplicaciones que requiran de una gran miniaturización y eficiencia.
	
	El primer paso para desarrollar el estudio es comprender cómo funciona un VCO.
	
	\section{VCO en anillo}
	
	Un VCO, siglas de \textit{Voltage Controlled Oscillator} es un componente electrónico que emite un tren de pulsos cuya frecuencia es proporcional a un voltaje de entrada.
	
	Un VCO en anillo es un tipo de oscilador controlado por voltaje. En su forma más básica, consiste en un número impar de puertas inversoras colocadas en un bucle cerrado. En las entradas de alimentación de las puertas se conecta la señal a modular. Este señal de entrada puede ser en voltaje o, a través de un transconductor, en corriente. La señal ya modulada aparece entre la salida y la entrada de cualquier par de puertas.
	
	Esta es la representación simbólica de una puerta inversora, con sus conexiones nombradas:
	\begin{figure}[H]
		\includegraphics[width=0.3\textwidth]{inverter-symbol.png}
		\caption[Símbolo y tabla de verdad de una puerta inversora]{Símbolo y tabla de verdad de una puerta inversora}
		\label{fig:inverter-symbol.png}
	\end{figure}
	
	Así se consigue un inversor en tecnología CMOS. El transistor superior es de canal-p, y el inferior es de canal-n.
	\begin{figure}[H]
		\includegraphics[width=0.4\textwidth]{inverter-sch.png}
		\caption[Esquemático de una puerta inversora con transistores MOS]{Esquemático de una puerta inversora con transistores MOS}
		\label{fig:inverter-sch.png}
	\end{figure}
	
	Cuando la señal de entrada está en cero lógico (0 voltios) el transistor canal-n se encuentra con una diferencia de voltaje baja entre la puerta y la fuente, así que no hay paso de corriente entre la fuente y el drenador. Por su parte, en el transistor canal-p la diferencia de voltaje entre la puerta y la fuente es grande (la fuente está conectada a una fuente de alimentación VCC que proporciona un voltaje llamado bias), así que la corriente entre su fuente y drenador es no nula. Así, en la salida el voltaje es equivalente al voltaje de bias VCC.
	
	Cuando la señal de entrada está en uno lógico (cercano al voltaje de bias), ocurre lo contrario: el transistor n entra en su región activa (permite el paso de corriente) mientras que el p entra en zona de corte (no permite el paso de corriente). Así, la salida estará conectada a tierra, normalmente cero voltios.

	\begin{figure}[H]
		\includegraphics[width=\textwidth]{vco-symbol.png}
		\caption[VCO compuesto por 5 puertas inversoras]{VCO compuesto por 5 puertas inversoras}
		\label{fig:vco-symbol.png}
	\end{figure}

	\begin{figure}[H]
		\includegraphics[width=\textwidth]{vco-sch.png}
		\caption[Esquemático de un VCO]{Esquemático de un VCO}
		\label{fig:vco-sch.png}
	\end{figure}

	El número impar de puertas inversoras provoca un estado de inestabilidad en el oscilador. Hay una pequeña demora en la activación de las puertas por efecto de las corrientes parásitas, que retrasan el cambio de voltaje, y por tanto el cambio de región de operación del transistor. La realimentación positiva en el anillo hace que se creen señales alternativas entre un 1 lógico y un 0 lógico entre la entrada y la salida de cada puerta. La frecuencia a la que estas señales cambian es proporcional al voltaje aplicado en la alimentación de las puertas (VCC en la figuras \ref{fig:inverter-symbol.png} y \ref{fig:inverter-sch.png}). La frecuencia de oscilación sigue la siguiente fórmula:
	
	\begin{figure}[H]
		\begin{equation}
		\label{vco-freq-sw-t}
		f = \frac{1}{2 n \tau}
		\end{equation}
		\footnotemark
	\end{figure}
	\footnotetext{Fuente: \cite{eric-thesis}}
	
	Donde $n$ es el número de puertas en el anillo y $\tau$ es el retraso de activación de la puerta, que es inversamente proporcional a la señal de entrada. Por ello, $f$ depende la señal de entrada.
	
	Asumiendo un comportamiento ideal del VCO, podemos expresar la relación entre entrada y salida como:
	\begin{figure}[H]
		\begin{equation}
		\label{vco-freq-ideal}
		f_{VCO}= f_{0} + K_{VCO} * V_{i}
		\end{equation}
		\footnotemark
	\end{figure}
	\footnotetext{Fuente: \cite{eric-thesis}}
	
	Donde $f_{VCO}$ es la frecuencia del oscilador, $f_{0}$ es la frecuencia en reposo (con una señal de entrada equivalente a 0), $K_{VCO}$ es la ganancia intrínseca en $Hz/V$, y $V_{i}$ es el valor de voltaje de entrada.
	
	Viendo el oscilador como un integrador, y tomando la fase de la señal como salida, en vez de la frecuencia, hacemos el siguiente análisis:
	
	\begin{figure}[H]
		\begin{equation}
		\label{vco-phase}
		\theta(t) = 2\pi\int_{0}^{t}f_{VCO}(\tau)d\tau = 2\pi f_{0}t + 2\pi K_{VCO}\int_{0}^{t}x(\tau)d\tau
		\end{equation}
		\footnotemark
	\end{figure}
	\footnotetext{Fuente: \cite{eric-thesis}}
	
	Haciendo un análisis en frecuencia, la transformada de laplace del oscilador resulta así:
	
	\begin{figure}[H]
		\begin{equation}
		\label{vco-laplace}
		\frac{2 \pi K_{VCO}}{s}
		\end{equation}
		\footnotemark
	\end{figure}
	\footnotetext{Fuente: \cite{eric-thesis}}
	

	Como se puede observar, la señal que entra al oscilador es analógica, mientras que la que sale ya es digital, aunque debe ser demodulada más tarde. Con pocos componentes, se consigue un integrador y cuantificador que funciona principalmente en el ámbito digital, evitando las restricciones que supone el procesado de una señal analógica, como se comentó en la introducción. De aquí surge el interés de los osciladores en anillo en su uso en ADCs.
	
	\section{Osciladores en anillo en ADCs}
	
	\subsection{Como parte de arquitecturas ya existentes}
	Ya que estos osciladores actúan como un integrador, pueden usarse en arquitecturas de ADC ya establecidas, como los \sigmadelta.
	
	Este es un ejemplo de un modulador \sigmadelta de segundo orden con un VCO en anillo sustituyendo el segundo integrador y el cuantificador.
	\begin{figure}[H]
		\includegraphics[width=0.7\textwidth]{sd-with-vco.png}
		\caption[Modulador \sigmadelta con un VCO]{Modulador \sigmadelta con un VCO\protect\footnotemark}
		\label{fig:sd-with-vco.png}
	\end{figure}
	\footnotetext{Fuente: \cite{eric-thesis}}
	
	En rendimiento es equivalente a una implementación habitual con opamps, pero con menor consumo y número de componentes. %TODO: corroborar con eric
	
	\subsection{Arquitecturas con solo oscilador en anillo}

	Además de la integración, un VCO en anillo también se encarga de la cuantificación. Así, se puede obtener un ADC con solo este componente.
	
	La forma más básica consiste en solo un VCO con un circuito sample-and-hold y un circuito para sacar la primera diferencia.
	\begin{figure}[H]
		\includegraphics[width=0.6\textwidth]{vco-adc-open-loop.png}
		\caption[ADC con VCO en bucle abierto]{ADC con VCO en bucle abierto\protect\footnotemark}
		\label{fig:vco-adc-open-loop.png}
	\end{figure}
	\footnotetext{Fuente: \cite{eric-thesis}}
	
	Haciendo un análisis en frecuencia de este sistema, tenemos:
	\begin{figure}[H]
		\includegraphics[width=0.6\textwidth]{vco-adc-open-loop-lp.png}
		\caption[Sistema con bucle abierto]{Sistema con bucle abierto\protect\footnotemark} %TODO: mejor nombre para esto
		\label{fig:vco-adc-open-loop-lp.png}
	\end{figure}
	\footnotetext{Fuente: \cite{eric-thesis}}
	
	\begin{figure}[h]
		\begin{equation}
		\label{vco-open-loop-laplace}
		Y(s)=2\pi K_{VCO}X(s) + (1 - z^{-1})Q(s)
		\end{equation}
	\end{figure}
	
	Donde $Q$ es el ruido de cuantificación del VCO, que toma como señal aleatoria aditiva a la salida del VCO. Tras la primera diferencia, el ruido de cuantificación sufre %TODO: qué sufre???
	
	Aunque el rendimiento de esta configuración es similar a los \sigmadelta convencionales, el VCO aporta un gran problema: la curva de respuesta voltaje-frecuencia no es lineal, porque el tiempo de activación de las puertas (ecuación \ref{vco-freq-sw-t}) varía en función de la alimentación de las puertas; en el caso de un oscilador en anillo, esta alimentación es la señal a modular. Esto provoca distorsión en la cuantificación, con lo que se pierde en resolución en el muestreo.
	
	Las soluciones más comunes a este problema son:
	
	\begin{itemize}
		\item Calibración Digital: Se hace un análisis de la curva de respuesta, se crea una tabla de mapeo entrada-salida, y por se hace la corrección por interpolación en un circuito digital. Aumenta mucho el área ocupada y el consumo.
		
		\item Modulación previa al VCO: Se coloca un modulador, habitualmente de tipo PWM, para limitar la frecuencia de oscilación de la señal que entra en el VCO. Es una solución más sencilla, pero el modulador PWM consume mucho y puede presentar no linealidad, así que el problema se mueve de componente, pero no se elimina de todo el sistema.
		
		\item Reducción de la señal de entrada: Si se consigue lo suficiente, se reduce el impacto de la amplitud de la señal en la linealidad del sistema. Algunas maneras usadas para esto son la inclusión de un ADC más básico antes del VCO, cuya señal se resta a la entrada. Así se consigue disminuir la amplitud de la señal que entra al VCO. Este método necesita de un ADC extra, con el consecuente aumento en consumo y espacio ocupado.
		
		\item Ajuste por circuito: Ajustando individualmente la alimentación de las puertas con componentes pasivos se puede paliar la no linealidad, pero esta técnica pierde fiabilidad una vez se toman en cuenta los errores de fabricación, la temperatura, y pequeñas variaciones en voltaje de alimentación.
	\end{itemize}
	
	Ninguna de las soluciones anteriores es perfecta. %TODO: terminar esto
	
	\section{Análisis matemático del VCO con realimentación negativa}
	
	Una manera común de linealizar un sistema es con un bucle de realimentación negativa. Partiendo de un ADC con VCO en bucle abierto, la manera más sencilla de incluir realimentación es unir la salida con la entrada a través de un sumador. En el bucle debe existir una conversión de la salida digital del VCO a la entrada analógica del sistema.

	\begin{figure}[H]
		\includegraphics[width=0.5\textwidth]{vco-diagram-closed-loop.png}
		\caption[ADC con VCO en bucle abierto, diagrama de bloques]{ADC con VCO en bucle cerrado, diagrama de bloques}
		\label{fig:vco-diagram-closed-loop.png}
	\end{figure}
	
	Haciendo un análisis del sistema, podemos despejar la función de transferencia del sistema:
	
	\begin{figure}[H]
		\label{vco-closed-loop-s}
		\begin{equation}
		\begin{array}{lcl}
		VCO & : & \frac{K_{VCO}}{s} \\
		Y(s) &=& Q(s) + \frac{K_{VCO}}{s}(X(s) - \beta Y(s) ) \\
		Y(s) &=& Q(s) + \frac{K_{VCO}}{s}X(s) - \frac{K_{VCO} \beta}{s}Y(s) \\
		Y(s) (1 + \frac{K_{VCO}\beta}{s}) &=& Q(s) + \frac{K_{VCO}}{s}X(s) \\
		Y(s) (\frac{s + K_{VCO}\beta}{s}) &=& Q(s) + \frac{K_{VCO}}{s}X(s) \\
		Y(s) &=& \frac{s}{s + K_{VCO}\beta}Q(s) + \frac{K_{VCO}}{s + K_{VCO}\beta}X(s) \\
		\end{array}
		\end{equation}
	\end{figure}
	
	Donde $Y(s)$ es la señal de salida, $X(s)$ es la señal de entrada, $K_{VCO}$ es la ganancia del VCO, $\beta$ es la ganancia del lazo de realimentación, y $Q(s)$ es el ruido de cuantificación modelado como una señal aditiva tras el VCO.
	%TODO: comentario Eric: explica qué significa la ecuación, lo de Q es la NTF y lo de X es la STF
	
	Respecto a los términos a la derecha de la ecuación superior, podemos deducir el siguiente comportamiento del sistema en función de la frecuencia:
	
	\begin{figure}[H]
		\label{vco-closed-loop-terms-x}
		\begin{equation}
		\begin{array}{lcl}
		\frac{K_{VCO}}{s + K_{VCO}\beta}X(s) & \\
		\frac{K_{VCO}}{s + K_{VCO}\beta}, s \to \infty: & = 0 \\
		\frac{K_{VCO}}{s + K_{VCO}\beta}, s \to 0: & = \frac{1}{\beta} \\
		\end{array}
		\end{equation}
	\end{figure}

	\begin{figure}[H]
		\label{vco-closed-loop-terms-q}
		\begin{equation}
		\begin{array}{lcl}
		\frac{s}{s + K_{VCO}\beta}Q(s) & \\
		\frac{s}{s + K_{VCO}\beta}, s \to 0: & = \frac{1}{\beta} \\
		\frac{s}{s + K_{VCO}\beta}, s \to \infty: & = 0 \\
		\end{array}
		\end{equation}
	\end{figure}

	Así, tenemos que a altas frecuencias, el coeficiente de $Q(s)$ aumenta y el de $X(s)$ disminuye. A bajas frecuencias, ocurre lo contrario. Por lo tanto, este sistema aplica un filtro paso alto a $Q(s)$ y un filtro paso bajo a $X(s)$. Esto discrimina el ruido de cuantificación en la banda de frecuencias de la señal de entrada. Para aumentar la SNR\footnote{Signal to Noise Ratio: ratio entre la señal y el ruido} necesitamos que estos valores sean grandes %TODO: explicar mejor por qué
	
	En cuanto a la linealidad del sistema: partimos de un DAC que recoge la frecuencia de salida del VCO y la convierte en corriente. Asumimos que esta conversión es lineal. Esta corriente se resta a la entrada. Integrando esta diferencia (a través del VCO), tiende a cero. Cuando la resta es cero, las señales de entrada y del bucle son iguales, y si la corriente que sale del DAC es lineal con respecto a la frecuencia es lineal, con lo que la corriente de entrada del sistema también es lineal.  Así que consiguiendo un DAC que realice la conversión con un buen nivel de linealidad dentro del ancho de banda de interés, resolvemos el problema de la linealidad en el VCO.
	
	\subsection{Lazo de realimentación por capacidades conmutadas}
	
	Dado que la ganancia del VCO es relativamente estable y más compleja de manipular, en este estudio nos centramos en la ganancia en el lazo de realimentación. En el lazo es necesario hacer una conversión de la señal modulada digital, a la señal de entrada analógica. Para esto es necesario buscar un DAC relativamente sencillo para no volver a encontrarnos el problema que intentamos evitar: número de componentes y consumo. Además, los requisitos para el DAC no son especialmente restrictivos, salvo que la transformación sea lineal.
	
	
	La solución escogida es el uso de un sistema de capacidades conmutadas. En nuestra implementación, este se compone de dos transistores pareados CMOS, en una distribución casi idéntica a las puertas lógicas inversoras.
	
	\begin{figure}[H]
		\includegraphics[width=0.6\textwidth]{sw-capacities-sch.png}
		\caption[Esquemático de circuito de capacidades conmutadas]{Esquemático de circuito de capacidades conmutadas}
		\label{fig:sw-capacities-sch.png}
	\end{figure}
	
	El circuito consta de dos transistores CMOS, canal-n y canal-p, y un condensador conectado entre fuente y drenador de los transistores. La fuente de alimentación $V4$ se conecta a la fuente del transistor canal-p, y la señal modulada en FM\footnote{Frequency Modulation, modulación en frecuencia.} se conecta a las puertas de ambos transistores. La señal PFM actúa a modo de reloj para controlar la activación de los transistores, que actúan a modo de interruptores.
	
	Este es el diagrama simbólico del sistema:
	
	\begin{figure}[H]
		\includegraphics[width=0.3\textwidth]{sw-capacities-symbol-1.png}
		\caption[Diagrama de circuito de capacidades conmutadas]{Diagrama de circuito de capacidades conmutadas}
		\label{fig:sw-capacities-symbol-1.png}
	\end{figure}

	Donde $\Phi$ es una señal de reloj de frecuencia variable y $\hat{\Phi}$ es la inversa del mismo reloj.
	
	A continuación se presenta un análisis del comportamiento en función del valor del reloj:
	
	\begin{figure}[H]
		\includegraphics[width=0.4\textwidth]{sw-capacities-symbol-2.png}
		\caption[Diagrama para $\Phi=1$]{Diagrama para $\Phi=1$}
		\label{fig:sw-capacities-symbol-2.png}
	\end{figure}
	Para $\Phi = 1$ y $\hat{\Phi} = 0$, el transistor superior se activa cerrando el circuito, y el inferior se desactiva abriéndolo. Esto permite el paso de corriente momentáneo al condensador $C$, que durante este semiperiodo se carga.
	
	\begin{figure}[H]
		\includegraphics[width=0.4\textwidth]{sw-capacities-symbol-3.png}
		\caption[Diagrama para $\Phi=0$]{Diagrama para $\Phi=0$}
		\label{fig:sw-capacities-symbol-3.png}
	\end{figure}
	Para $\Phi = 0$ y $\hat{\Phi} = 1$, el transistor superior se desactiva abriendo el circuito mientras que el inferior se cierra conectando el condensador con la tierra. Así, se crea un flujo de corriente desde el condensador que lo descarga.
	
	Las siguientes ecuaciones describen la corriente de salida en función de la frecuencia.
	
	\begin{figure}[H]
		\label{sw-capacities-eqs}
		\begin{equation}
		\begin{array}{c}
		I_C = \frac{\Delta Q}{\Delta t} = \\
		= \frac{C(V_{A}-V_{B})}{T} = Cf(V_{A}-V_{B}) \\
		si\ \ V_{A} = V_{dd}\ \ y\ \ V_{B} = V_{GND} = 0 \implies I_C = Cf(V_{dd})
		\end{array}
		\end{equation}
	\end{figure}
	
	Donde $I_C$ es la corriente media que pasa por el condensador.
	
	Teniendo corriente equivalente y voltaje de referencia, podemos modelar el sistema como una impedancia variable.
	
	\begin{figure}[H]
		\label{sw-capacities-var-res}
		\begin{equation}
		\begin{array}{c}
		Z_{eq} = \frac{V_{dd}}{I_C} = \frac{V_{dd}}{Cf(V_{dd})} = \frac{1}{fC} \\
		\end{array}
		\end{equation}
	\end{figure}
	
	Así obtenemos una resistencia variable proporcional a la frecuencia de entrada, con la que podemos obtener la corriente proporcional a la frecuencia del VCO para nuestro bucle de realimentación.
	
	Debemos tener en cuenta que los transistores tienen unas ciertas corrientes parasíticas fuera de su modelo ideal. Estas corrientes provocan que un transistor abierto tenga una impedancia muy alta, pero no cero, y uno cerrado tenga una impedancia muy baja, pero nunca nula. Relacionando este paso de corriente por los transistores con un voltaje de referencia, podemos modelar los efectos parasíticos como una impedancia intrínseca en los transistores.
	
	Este es el circuito equivalente:
	\begin{figure}[H]
		\includegraphics[width=0.2\textwidth]{sw-capacities-var-res-block.png}
		\caption[Diagrama de bloques del sistema de impedancias equivalente]{Diagrama de bloques del sistema de impedancias equivalente}
		\label{fig:sw-capacities-var-res-block.png}
	\end{figure}
	
	Donde $Z_{eq}$ es la impedancia variable equivalente, y $Z_{on}$ y $Z_{off}$ son las impedancias de transistor activado y en corte. Como se abren y cierran de manera alternativa, y asumiendo un comportamiento ideal del sistema (activación/desactivación instantánea, sin solapamiento), el circuito equivalente tendrá una impedancia de cada en serie. Estas impedancias de los transistores dependen de factores como tecnología de fabricación, tamaño, y defectos de fabricación. En cualquier caso, $Z_{on}$ es muy bajo, y $Z_{off}$ es muy alto.
	
	Queda este modelo ideal para el DAC por capacidades conmutadas:
	
	\begin{figure}[H]
		\label{sw-capacities-i_eq}
		\begin{equation}
		\begin{array}{c}
		I_{eq} = \frac{V_{dd}}{\frac{1}{fC} + Z_{on} + Z_{off}} \\
		\end{array}
		\end{equation}
	\end{figure}
	
	Con esto, ya tenemos nuestro DAC que transforma la señal modulada en frecuencia de 1 bit de manera sencilla y con pocos componentes.
	
	\section{Simulaciones del modelo}
	
	Tras el análisis matemático expuesto en las secciones anteriores, procedemos a realizar simulaciones para comprobar la validez de la arquitectura. Usaremos LTSpice para elaborar esquemáticos y lanzar simulaciones, y Matlab para analizar los resultados.
	
	En estas simulaciones se han usado las librerías de transistores CMOS de la compañía TSMC, cedidas al Departamento de Tecnologías Electrónicas. Estas librerías tienen los parámetros necesarios para poder simular su comportamiento en un programa SPICE.
	
	\subsection{Herramientas de simulación}
	
	\subsubsection{Reloj de frecuencia variable en LTSpice}
	Para conseguir la curva de respuesta un sistema, podemos hacerlo por interpolación, tomando varios resultados discretos para diferentes valores de entrada, en este caso, frecuencia de reloj, o podemos usar una entrada que incremente su valor de forma lineal con el tiempo. Como no existe un componente con este comportamiento en LTSpice, se ha creado uno nuevo:
	
	\begin{figure}[H]
		\includegraphics[width=0.8\textwidth]{ltspice-clk-freq.png}
		\caption[Esquemático de reloj con frecuencia incremental]{Esquemático de reloj con frecuencia incremental}
		\label{fig:ltspice-clk-freq.png}
	\end{figure}
	
	Este componente utiliza un interruptor y una fuente de voltaje cuyo valor se calcula con una función sinusoidal en función del tiempo.
	\begin{figure}[H]
		\label{sw-capacities-v_eq}
		\begin{equation}
		\begin{array}{c}
		V=sin(2*\pi*t*(f_{init}+f_{gain}*t))+V_{offset}
		\end{array}
		\end{equation}
	\end{figure}
	
	Donde $t$ es el tiempo en cada paso de la simulación, $f_{init}$ es la frecuencia en $t=0$ del sistema, $f_{gain}$ es un parámetro que dicta el incremento de la frecuencia por unidad de tiempo, y $V_{offset}$ es el voltaje medio de la fuente. Las entrada de este circuito es $f_{gain}$ y el voltaje nominal del reloj $clk\_v$. Además, para que el 0 lógico del reloj tenga un voltaje igual a cero, hay una resistencia \textit{pull-down} justo antes de la salida.
	
	Para comprobar que el componente funciona, a continuación se presenta una simulación rápida. Los valores de las variables para esta simulación son los siguientes:
	\begin{table}[H]
		\label{tab:parameters-clk-freq-sim}
		\caption{Parámetros de simulación del reloj de frecuencia incremental}
		\begin{tabular}{lr}
			clk\_v & 1V \\
			f\_init & 3e3 \\
			f\_gain & 3e7 \\
			Paso de simulación & 1ns \\
			Tiempo de simulación & 10ms
		\end{tabular}
	\end{table}

	Este es el resultado de la simulación:
	
	\begin{figure}[H]
		\includegraphics[width=1\textwidth]{clk-freq-sim-waveform.PNG}
		\caption[Simulación: Forma de onda del voltaje en la salida clk\_out]{Simulación: Forma de onda del voltaje en la salida clk\_out}
		\label{fig:clk-freq-sim-waveform.PNG}
	\end{figure}
	
	Se puede observar que la forma de onda del reloj es cuadrada, y va aumentando según pasa el tiempo de simulación. Haciendo zoom en una zona cualquiera, y tomando medidas, podemos calcular la frecuencia de reloj en función de $1/T$:

	\begin{figure}[H]
		\includegraphics[width=1\textwidth]{clk-freq-sim-waveform-zoom.PNG}
		\caption[Simulación: zoom en sección de la forma de onda]{Simulación: zoom en sección de la forma de onda}
		\label{fig:clk-freq-sim-waveform-zoom.PNG}
	\end{figure}
	
	En esta sección, el periodo es aproximadamente $T=3.2us$. Las ecuaciones que describen la frecuencia real como la teórica son las siguientes:
	
	\begin{figure}[H]
		\begin{equation} \label{eq:clk-freq_eqs_freq}
		\begin{array}{c}
		Real:\; f = \frac{1}{3.2e-6} = 312.5kHz \\
		Te\acute{o}rico:\; time\approx5.111e-3 \implies f = (3e3 + 3e7 * time) = 156.3kHz \\
		\end{array}
		\end{equation}
	\end{figure}

	A la vista queda una cierta discrepancia entre valores. Esto se debe a falta de precisión absoluta en la simulación, y a errores en la toma de medidas de manera visual.
	
	Es necesario un método que permita el análisis de los datos de manera programática, y no manual. Ya que LTSpice permite exportar las formas de onda como matriz de puntos x-y, podemos usar Matlab para el análisis.
	
	\subsubsection{Procesado de formas de onda en Matlab}
	
	Partiendo de la matriz de puntos x-y (voltaje-tiempo) de la simulación del apartado anterior, nuestro objetivo es producir una recta frecuencia-tiempo.
	
	Para calcular el periodo en función del tiempo, hacemos una función que guarde el tiempo en que cada periodo comienza, atravesando un threshold, y con el periodo calcularemos su inversa, que es la frecuencia.
	
	Encontramos un problema al analizar el dataset: el paso de simulación es variable, lo que significa que los puntos no están uniformemente espaciados con respecto al tiempo, así que primero debemos limpiar estos datos. Generamos un vector de tiempos con el rango del dataset de simulación, e interpolamos los datos originales para sacar el valor de V que corresponde a cada tiempo. Esto genera un cierto error de resolución %TODO: qué tipo de error es?
	, pero veremos que para nuestro caso es despreciable.
	
	Este es el algoritmo que define el comportamiento del script de procesado:
	
	\begin{lstlisting}
dataset = load(file_name, "-ascii");
length_dataset = length(dataset);
times_eq_spaced = linspace(0, dataset(end,1), length_dataset);
dataset_eq_spaced(:) = interp1(dataset(:,1),dataset(:,2),times_eq_spaced);
timestamp_periods = [];
threshold = 0.8;
for i = 2:length(dataset_eq_spaced)
	if ( dataset_eq_spaced(i) > threshold ) && ( dataset_eq_spaced(i-1) < threshold )
		timestamp_periods = [ timestamp_periods; i t(i) dataset_eq_spaced(i) ];
	end
end
freqs = [];
for i = 1:length(timestamp_periods)
	if i == 1
		freqs(i) = ( 1/( timestamp_periods(i,2) - 0 ) );
	else
		freqs(i) = ( 1/( timestamp_periods(i,2) - timestamp_periods(i-1,2) ) );
	end
end
freqs_ordered = sort(freqs);
plot(Tperiods(:,2), freqs_ordered)
	\end{lstlisting} 
	%TODO: aquí hay trampilla: por algún motivo la frecuencia sale el doble de lo teórico, así que donde pone 1/T, en el script puse 0.5/T

	Este es el resultado del análisis con el dataset de la simulación \ref{fig:clk-freq-sim-waveform.PNG}:
	
	\begin{figure}[H]
		\centerline{\includegraphics[width=1.1\textwidth]{ml-clk-freq-curve.png}}
		\caption[Curva frecuencia-tiempo del reloj de frecuencia variable]{Curva frecuencia-tiempo del reloj de frecuencia variable}
		\label{fig:ml-clk-freq-curve.png}
	\end{figure}

	Salvo errores de resolución por ser un dataset discreto y finito, la curva coincide con el resultado esperado. Queda demostrado que el reloj de frecuencia variable funciona, y las ecuaciones que describen su comportamiento son las expuestas en \ref{eq:clk-freq_eqs_freq}.
	
	Para las demás simulaciones se usarán scripts muy similares, ya que también estaremos analizando ondas cuadradas cuyo parámetro de interés es la frecuencia.	




	\subsection{Simulación del DAC por capacidades conmutadas}
	
	Este es el esquemático en LTSpice usado para simular el DAC por capacidades conmutadas:
	
	\begin{figure}[H]
		\includegraphics[width=0.8\textwidth]{ltspice-sw-cap-empty.png}
		\caption[Esquemático en LTSpice del modelo de DAC por capacidades conmutadas]{Esquemático en LTSpice del modelo de DAC por capacidades conmutadas}
		\label{fig:ltspice-sw-cap-empty.png}
	\end{figure}
	
	En la esquina superior derecha se reúnen los parámetros básicos de los transistores: sus dimensiones en ancho y largo. Los valores usados se corresponden con %TODO: por qué usamos estos tamaños de transistor para simular??
	%TODO: explicar por qué tienen tamaños diferentes??
	% TODO: explicar por qué no hay condensador!
	El voltaje de referencia escogido, 1.8V, %TODO: por qué 1.8??
	
	Añadimos el reloj de frecuencia variable explicado anteriormente y procedemos a simular.

	\begin{figure}[H]
		\includegraphics[width=0.8\textwidth]{ltspice-sw-with-clk-freq.png}
		\caption[Esquemático del circuito de capacidades conmutadas con reloj de frecuencia variable]{Esquemático del circuito de capacidades conmutadas con reloj de frecuencia variable}
		\label{fig:ltspice-sw-with-clk-freq.png}
	\end{figure}

	%TODO: no consigo que en el análisis me salga una línea recta :(
	
	%TODO: terminar esto

	
	\subsection{Modelo sencillo de ADC con VCO, abierto} %TODO: este título tampoco me gusta
	
	Partiendo del modelo \ref{fig:vco-adc-open-loop.png}, montamos el esquemático en LTSPice.
	
	\begin{figure}[H]
		\includegraphics[width=\textwidth]{ltspice-vco-open.png}
		\caption[Esquemático del ADC por VCO, abierto]{Esquemático del ADC por VCO, abierto}
		\label{fig:ltspice-vco-open.png}
	\end{figure}
	
	A la izquierda tenemos un generador de señal sinusoidal de 250kHz con offset de 0.85V y amplitud 0.5V. Así se emula las características de las posibles señales a capturar en las aplicaciones a las que va destinado el sistema. En la parte superior, tenemos un espejo de corriente CMOS, que sirve para desacoplar la entrada del VCO y aportar ganancia %TODO: explicar espejo de corriente? aporta ganancia?
	En el centro está el VCO sencillo de cinco fases. %TODO: fases?
	
	Este es el resultado de la simulación:
	
	\begin{figure}[H]
		\includegraphics[width=\textwidth]{ltspice-vco-open-wf.png}
		\caption[Forma de onda de la simulación del VCO abierto]{Forma de onda de la simulación del VCO abierto}
		\label{fig:ltspice-vco-open-wf.png}
	\end{figure}

	\begin{figure}[H]
		\includegraphics[width=\textwidth]{ltspice-vco-open-wf-zoom.png}
		\caption[Forma de onda de la simulación del VCO abierto, detalle]{Forma de onda de la simulación del VCO abierto, detalle}
		\label{fig:ltspice-vco-open-wf-zoom.png}
	\end{figure}
	
	\begin{figure}[H]
		\includegraphics[width=\textwidth]{ltspice-vco-open-wf-fft.png}
		\caption[FFT de la señal demodulada del VCO abierto]{FFT\footnote{Fast Fourier Transform, o transformada rápida de Fourier} de la señal demodulada del VCO abierto}
		\label{fig:ltspice-vco-open-wf-fft.png}
	\end{figure}

	Como se puede observar, la forma de onda en \ref{fig:ltspice-vco-open-wf.png} no es perfectamente cuadrada, aunque \ref{fig:ltspice-vco-open-wf-fft.png} demuestra que sí está modulada, porque el primer harmónico coincide %TODO: pico? harmónico? cómo se llama esto?
	con la frecuencia de la señal original, así como el segundo y tercero con sus múltiplos. El umbral de ruido es alto para frecuencias altas, pero limitando el ancho de banda esto no supone un problema. En los siguientes apartados trataremos de aumentar la ganancia del primer harmónico, disminuyendo la de los demás harmónicos y el umbral de ruido.
	
	\subsection{Modelo sencillo de ADC VCO, con bucle cerrado}
	
	Visto el comportamiento de un VCO en bucle abierto, es el turno de probar cómo se comporta con un bucle de realimentación. Dado que el DAC no invierte la señal de entrada, debemos buscar una solución para hacer negativo el bucle de realimentación. La manera más directa de hacer esto es replicar el circuito con un segundo ADC cuya entrada sea la inversa de la señal original. Así queda el circuito:
	
	\begin{figure}[H]
		\includegraphics[width=\textwidth]{ltspice-vco-closed-sch.png}
		\caption[Esquemático del VCO doble con DACs cruzados]{Esquemático del VCO doble con DACs cruzados}
		\label{fig:ltspice-vco-closed-sch.png}
	\end{figure}

	El generador de señal \textbf{V1}, a la izquierda, proporciona una señal sinusoidal de 250kHz, con un offset (\textbf{V3}) de 0.85V. El componente \textbf{E4} invierte la señal sinusoidal para pasarla al segundo VCO. A continuación, hay un consensador para desacoplar la parte continua de la entrada del resto del circuito. Lo siguiente es un divisor de tensión para sumar la realimentación a la entrada. Más tarde está el espejo de corriente, explicado en el modelo anterior, y después el VCO. De una de las fases del VCO se toma una señal que va al DAC opuesto. Como las señales de entrada de cada uno están desfasadas 180º, cruzando las entradas de los DACs se consigue que los lazos de realimentación sean negativos. La alimentación del sistema, tanto DAC como espejo de corriente, viene de la fuente \textbf{V2}, de 1.8V.
	
	Este es el resultado de la simulación:
	
	\begin{figure}[H]
		\includegraphics[width=\textwidth]{ltspice-vco-closed-wf.png}
		\caption[Forma de onda de la simulación del VCO con lazo de realimentación cruzado]{Forma de onda de la simulación del VCO con lazo de realimentación cruzado}
		\label{fig:ltspice-vco-closed-wf.png}
	\end{figure}
	
	\begin{figure}[H]
		\includegraphics[width=\textwidth]{ltspice-vco-closed-wf-zoom.png}
		\caption[Detalle de la forma de onda \ref{fig:ltspice-vco-closed-wf.png}]{Detalle de la forma de onda \ref{fig:ltspice-vco-closed-wf.png}}
		\label{fig:ltspice-vco-closed-wf-zoom.png}
	\end{figure}
	
	La forma de onda no es perfectamente cuadrada, pero rectificaremos eso en las siguientes simulaciones con algunos componentes más. El resultado de la modulación de la señal se puede ver en la transformada rápida de Fourier:
	
	\begin{figure}[H]
		\includegraphics[width=\textwidth]{ltspice-vco-closed-wf-fft.png}
		\caption[FFT de la forma de onda \ref{fig:ltspice-vco-closed-wf.png}]{FFT de la forma de onda \ref{fig:ltspice-vco-closed-wf.png}}
		\label{fig:ltspice-vco-closed-wf-fft.png}
	\end{figure}
	
	El primer armónico es pronunciado, y coincide con la frecuencia de la señal de entrada, así que la modulación es correcta. El resto de armónicos no son tan pronunciados como en el sistema de bucle abierto (figura \ref{fig:ltspice-vco-open-wf-fft.png}). Se ha conseguido una mejora en ruido armónico dentro del ancho de banda, pero el umbral de ruido aumenta. El siguiente paso es colocar un circuito de primera diferencia %TODO: se llama así? qué hace???
	
	\subsection{Modelo de VCO con primera diferencia}
	
	%TODO: explicar aquí lo de la primera diferencia
	
	Este es el módulo de primera diferencia:
	
	\begin{figure}[H]
		\includegraphics[width=\textwidth]{ltspice-vco-closed-diff-module.PNG}
		\caption[Esquemático del módulo de primera diferencia]{Esquemático del módulo de primera diferencia}
		\label{fig:ltspice-vco-closed-diff-module.PNG}
	\end{figure}
	
	Las señales de fase de ambos VCO entran al módulo por la pata \textbf{D} de cada flip-flop a la izquierda. La salida del primer flip-flop entra al segundo inmediatamente. La salida de el primero y el segundo entra en la puerta XOR (\textbf{A3} y \textbf{A6}). A su vez, la salida de ambas puertas se suma por medio de los componentes \textbf{E2} y \textbf{E1}, invirtiendo una de ellas para compensar el desfase que introdujimos en la señal original (ver apartado anterior). %TODO: qué más digo de esto?
	
	Añadiendo el módulo, queda el siguiente circuito completo:
	
	\begin{figure}[H]
		\includegraphics[width=\textwidth]{ltspice-vco-closed-diff.png}
		\caption[Esquemático del VCO con circuito de primera diferencia]{Esquemático del VCO con circuito de primera diferencia}
		\label{fig:ltspice-vco-closed-diff.png}
	\end{figure}
	
	Y simulando queda lo siguiente:
	
	\begin{figure}[H]
		\includegraphics[width=\textwidth]{ltspice-vco-closed-diff-wf.png}
		\caption[Forma de onda de la simulación del sistema con primera diferencia]{Forma de onda de la simulación del sistema con primera diferencia}
		\label{fig:ltspice-vco-closed-diff-wf.png}
	\end{figure}
	
	\begin{figure}[H]
		\includegraphics[width=\textwidth]{ltspice-vco-closed-diff-wf-zoom.png}
		\caption[Detalle de la forma de onda \ref{fig:ltspice-vco-closed-diff-wf.png}]{Detalle de la forma de onda \ref{fig:ltspice-vco-closed-diff-wf.png}}
		\label{fig:ltspice-vco-closed-diff-wf-zoom.png}
	\end{figure}

	Se puede apreciar que ya tenemos una señal perfectamente cuadrada y %TODO: qué forma tiene esto? amplitud (1, -1), por qué? qué clase de circuito toma esta señal?
	
	Haciendo la FFT de la onda anterior:
	
	\begin{figure}[H]
		\includegraphics[width=\textwidth]{ltspice-vco-closed-diff-wf-fft.PNG}
		\caption[FFT de la forma de onda \ref{fig:ltspice-vco-closed-diff-wf.png}]{FFT de la forma de onda \ref{fig:ltspice-vco-closed-diff-wf-fft.PNG}}
		\label{fig:ltspice-vco-closed-diff-wf-fft.PNG}
	\end{figure}
	
	Con respecto a la FFT de la figura \ref{fig:ltspice-vco-closed-wf-fft.png}, el armónico principal se acerca a los 0dB aún más, además de que se reduce mucho el segundo armónico. El umbral de ruido aumenta hasta los -60dB %TODO: por qué? no debería bajar?
	
	Con todo este circuito, ya hemos conseguido el objetivo principal de conseguir un modulador funcional basado en VCO con el menor número posible de componentes.
	
	
\chapter{Conclusiones (?)}
\chapter{Entorno socioeconómico (?)}
\chapter{Presupuesto / planificación / proceso (?)}

%----------
%	BIBLIOGRAFÍA
%----------	

\nocite{*} % Si quieres que aparezcan en la bibliografía todos los documentos que la componen (también los que no estén citados en el texto) descomenta está lína

\clearpage

\addcontentsline{toc}{chapter}{Bibliografía}

\setquotestyle[english]{british} % Cambiamos el tipo de cita porque en el estilo IEEE se usan las comillas inglesas.
\printbibliography

%----------
%	ANEXOS
%----------	

% Si tu trabajo incluye anexos, puedes descomentar las siguientes líneas
%\chapter* {Anexo x}
%\pagenumbering{gobble} % Las páginas de los anexos no se numeran



\end{document}